<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa Interactivo DIMEC</title>
  <style>
    body { margin: 0; font-family: sans-serif; }

    /* === Controles arriba fijo === */
    #controls {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(4px);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.25);
      display: flex;
      flex-direction: row;
      gap: 15px;
      align-items: center;
      z-index: 100;
    }

    select, input[type="text"], button {
      padding: 5px;
      font-size: 1em;
    }

    #resetViewBtn {
      display: inline-block !important; /* siempre visible */
    }

    /* === Plano general + overlay === */
    #plano-container {
      position: relative;
      width: 100%;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    
    #svgOverlay {
      height: 850px;
      width: auto;
      display: block;
      margin: 0 auto;
    }

    #svgGeneral {
      background: white;   /* fondo blanco siempre */
      opacity: 1;          /* opaco por defecto */
      transition: opacity 0.3s ease;
      z-index: 1;
    }

    #svgOverlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: auto;
      z-index: 10;
    }

    .modal {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border: 1px solid #ccc;
      padding: 15px;
      max-width: 300px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      display: none;
      z-index: 200;
    }
    .modal.active { display: block; }

    @media (max-width: 600px) {
      .modal {
        top: auto; bottom: 0; right: 0; left: 0;
        max-width: none; width: 100%;
        border-radius: 10px 10px 0 0;
      }
    }

    /* === Lista de sugerencias === */
    #suggestions {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 240px;
      overflow-y: auto;
      display: none;
      z-index: 150;
    }
    #suggestions li {
      padding: 6px 8px;
      cursor: pointer;
    }
    #suggestions li:hover {
      background: #f0f0f0;
    }

    /* === Lightbox === */
    #lightbox {
      display: none;               /* oculto por defecto */
      position: fixed;
      z-index: 9999;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); /* fondo oscuro */
      justify-content: center;
      align-items: center;
    }

    #lightbox img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
    }

    #lightboxClose {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 2em;
      cursor: pointer;
    }

  </style>
</head>
<body>
  <div id="controls">
    <div style="position:relative; width: 320px;">
      <input type="text" id="searchInput" placeholder="Buscar por nombre..." autocomplete="off" style="width:100%;">
      <ul id="suggestions"></ul>
    </div>
    <button id="resetViewBtn">游댃 Volver al mapa general</button>
  </div>

  <div id="plano-container">
    <!-- plano de fondo -->
    <object id="svgGeneral" type="image/svg+xml"></object>
    <!-- overlay (edificio/piso) -->
    <object id="svgOverlay" type="image/svg+xml"></object>
  </div>

  <div id="infoModal" class="modal">
    <button id="closeModal" style="position:absolute;top:5px;right:5px;">&times;</button>
    <div id="modalContent"></div>
  </div>

  <div id="lightbox">
    <span id="lightboxClose">&times;</span>
    <img id="lightboxImg" src="" alt="Imagen ampliada">
  </div>

  <script>
  /* ---------- Diccionario nombres edificios ---------- */
  const nombresEdificios = {
    "A": "Sector: Procesos",
    "B": "Sector: Termofluidos",
    "C": "Sector: Fundici칩n",
    "General": "Plano General"
  };

  /* ---------- Modal ---------- */
  const modal = document.getElementById("infoModal");
  document.getElementById("closeModal").addEventListener("click", ()=> modal.classList.remove("active"));

  function showInfo(data){
    document.getElementById("modalContent").innerHTML = `
      <h3>${data.nombre}</h3>
      ${data.media && data.media.video ? `<video controls style="width:100%" autoplay="true" loop=true muted="true"><source src="${data.media.video}" type="video/mp4"></video>` : ""}
      <p><strong>Ubicaci칩n:</strong> ${data.ubicacion}</p>
      <p>${data.descripcion || ""}
      ${data.media && data.media.foto ? `<img src="${data.media.foto}" alt="${data.nombre}" style="width:100%;cursor:pointer;"onclick="openLightbox('${data.media.foto}')">` : ""}
    `;
    modal.classList.add("active");
  }

  /* ---------- ZoomLayer seguro ---------- */
  function crearZoomLayerSiHaceFalta(svgDoc){
    const svg=svgDoc.querySelector("svg");
    if(!svg) return null;
    let gWrapper=svg.querySelector("#zoomLayer");
    if(!gWrapper){
      gWrapper=svgDoc.createElementNS("http://www.w3.org/2000/svg","g");
      gWrapper.setAttribute("id","zoomLayer");
      svg.appendChild(gWrapper);
    }
    return gWrapper;
  }

  /* ---------- Marcadores ---------- */
  let allMarkers=[];
  function placeMarkers(svgRoot, ubicaciones){
    allMarkers = [];
    ubicaciones.forEach(ubicacion=>{
      const target=svgRoot.ownerDocument.getElementById(ubicacion.id);
      if(!target) return;
      if(!target.__attached){
        target.setAttribute("fill","transparent");
        target.setAttribute("stroke","white");
        target.style.cursor="pointer";
        target.dataset.nombre=(ubicacion.nombre||"").toLowerCase();
        target.addEventListener("mouseenter",()=> target.setAttribute("fill","black"));
        target.addEventListener("mouseleave",()=> target.setAttribute("fill","transparent"));
        target.addEventListener("click",()=> showInfo(ubicacion));
        target.__attached = true;
      }
      allMarkers.push(target);
    });
  }

  /* ---------- Filtros m칤nimos (solo b칰squeda) ---------- */
  function aplicarFiltrosYBusqueda(){
    const search=document.getElementById("searchInput").value.toLowerCase();
    allMarkers.forEach(marker=>{
      const nombre=marker.dataset.nombre||"";
      const matchName=nombre.includes(search);
      marker.setAttribute("fill", (search && matchName) ? "black":"transparent");
    });
  }
  document.getElementById("searchInput").addEventListener("input",aplicarFiltrosYBusqueda);

  /* ---------- Cargar plano general ---------- */
  function cargarPlanoGeneral(svgFile,jsonFile){
    const obj=document.getElementById("svgGeneral");
    obj.setAttribute("data",svgFile);
    obj.onload=function(){
      const svgDoc=obj.contentDocument;
      if(!svgDoc) return;
      const gWrapper=crearZoomLayerSiHaceFalta(svgDoc);
      fetch(jsonFile).then(r=>r.json()).then(data=>placeMarkers(gWrapper,data));
    };
  }

  /* ---------- Autocomplete global ---------- */
  function debounce(fn,wait){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait);};}
  const INDEX_FILE="data/ubicaciones_index.json"; let mapsIndex=[],nameIndex=[],currentMap=null;
  async function buildIndex(){
    const res=await fetch(INDEX_FILE);
    mapsIndex=await res.json().then(j=>j.maps||j);
    await Promise.all(mapsIndex.map(async entry=>{
      try{const r=await fetch(entry.json);if(!r.ok)return;const items=await r.json();
        items.forEach(it=>nameIndex.push({nombreLower:(it.nombre||"").toLowerCase(),item:it,mapEntry:entry}));
      }catch(e){} }));
  }

  const suggestionsEl=document.getElementById("suggestions"),searchInput=document.getElementById("searchInput");

  function showSuggestions(list){
    suggestionsEl.innerHTML="";
    if(!list.length){ suggestionsEl.style.display="none"; return; }
    list.forEach(s=>{
      const li = document.createElement("li");
      const edificioNombre = nombresEdificios[s.mapEntry.edificio] || s.mapEntry.edificio;
      li.textContent = `${s.item.nombre} - ${edificioNombre} - Piso ${s.mapEntry.piso}`;
      li.onclick = ()=> selectSuggestion(s);
      suggestionsEl.appendChild(li);
    });
    suggestionsEl.style.display="block";
  }

  function clearSuggestions(){
    suggestionsEl.style.display="none";
    suggestionsEl.innerHTML="";
  }

  searchInput.addEventListener("input",debounce(()=>{
    const q=searchInput.value.trim().toLowerCase(); if(!q){clearSuggestions();return;}
    const starts=nameIndex.filter(n=>n.nombreLower.startsWith(q)).slice(0,10);
    const contains=nameIndex.filter(n=>n.nombreLower.includes(q)&&!n.nombreLower.startsWith(q)).slice(0,10-starts.length);
    showSuggestions(starts.concat(contains));
  },150));

  searchInput.addEventListener("keydown",e=>{
    if(e.key==="Enter"){
      const q=searchInput.value.trim().toLowerCase();if(!q)return;
      const pick=nameIndex.find(n=>n.nombreLower===q)||nameIndex.find(n=>n.nombreLower.startsWith(q));
      if(pick) selectSuggestion(pick);
      clearSuggestions();
      searchInput.blur();
    }
    else if(e.key==="Escape") clearSuggestions();
  });

  /* ---------- Selecci칩n de sugerencia ---------- */
  async function selectSuggestion(entry){
    const mapEntry=entry.mapEntry;

    const objOverlay=document.getElementById("svgOverlay");
    await new Promise(resolve=>{
      objOverlay.setAttribute("data", mapEntry.svg);
      objOverlay.onload=()=>resolve();
    });
    currentMap=mapEntry;

    try {
      const r=await fetch(mapEntry.json);
      const data=await r.json();
      const svgDoc=objOverlay.contentDocument;
      const svg = svgDoc.querySelector("svg");
      // 游녤 fondo blanco semitransparente detr치s del edificio
      if(svg && !svg.querySelector("#overlayBackground")){
        const rect = svgDoc.createElementNS("http://www.w3.org/2000/svg","rect");
        rect.setAttribute("id","overlayBackground");
        rect.setAttribute("x","0");
        rect.setAttribute("y","0");
        rect.setAttribute("width","100%");
        rect.setAttribute("height","100%");
        rect.setAttribute("fill","white");
        rect.setAttribute("opacity","0.1");
        svg.insertBefore(rect, svg.firstChild);
      }
      const gWrapper=crearZoomLayerSiHaceFalta(svgDoc);
      placeMarkers(gWrapper,data);
    } catch(e){}

    focusOnLocation(entry.item);
    clearSuggestions();
    searchInput.blur();

    // 游녤 Hacer transparente el plano general
    document.getElementById("svgGeneral").style.opacity = "0.1";
  }

  /* ---------- Focus ---------- */
  function focusOnLocation(ubicacion){
    const obj=document.getElementById("svgOverlay"),svgDoc=obj.contentDocument;if(!svgDoc)return;
    const el=svgDoc.getElementById(ubicacion.id);if(!el)return;
    el.setAttribute("fill","black"); el.setAttribute("opacity","0.9");
    showInfo(ubicacion);
  }

  /* ---------- Reset ---------- */
  document.getElementById("resetViewBtn").addEventListener("click", async ()=>{
    const general = mapsIndex.find(m=>(m.edificio&&m.edificio.toLowerCase()==="general")||m.piso===0);
    const defaultMap = general || mapsIndex[0];
    if(!defaultMap) return;

    const objGeneral=document.getElementById("svgGeneral");
    await new Promise(resolve=>{
      objGeneral.setAttribute("data",defaultMap.svg);
      objGeneral.onload=()=>resolve();
    });
    currentMap=defaultMap;

    try {
      const r=await fetch(defaultMap.json);
      const data=await r.json();
      const svgDoc=objGeneral.contentDocument;
      const gWrapper=crearZoomLayerSiHaceFalta(svgDoc);
      placeMarkers(gWrapper,data);
    } catch(e){}

    // limpiar overlay
    document.getElementById("svgOverlay").removeAttribute("data");

    // volver opaco el plano general
    document.getElementById("svgGeneral").style.opacity = "1";

    modal.classList.remove("active");
    document.getElementById("searchInput").value="";
    clearSuggestions();
  });

  /* ---------- Inicio ---------- */
  window.addEventListener("load",async()=>{
    await buildIndex();
    const general=mapsIndex.find(m=>(m.edificio&&m.edificio.toLowerCase()==="general")||m.piso===0);
    const defaultMap=general||mapsIndex[0];
    if(defaultMap){
      document.getElementById("svgGeneral").setAttribute("data",defaultMap.svg);
      currentMap=defaultMap;
    }
  });

  function openLightbox(src){
    const lightbox = document.getElementById("lightbox");
    const img = document.getElementById("lightboxImg");
    img.src = src;
    lightbox.style.display = "flex";
  }

  document.getElementById("lightboxClose").addEventListener("click", ()=>{
    document.getElementById("lightbox").style.display = "none";
  });

  // cerrar con clic en el fondo
  document.getElementById("lightbox").addEventListener("click",(e)=>{
    if(e.target.id === "lightbox"){
      document.getElementById("lightbox").style.display = "none";
    }
  });

  </script>
</body>
</html>
