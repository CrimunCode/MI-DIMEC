<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa Interactivo DIMEC</title>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #controls {
      background: #f0f0f0;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    select, input[type="text"] { padding: 5px; font-size: 1em; }
    #plano-container { position: relative; width: 100%; max-width: 1200px; margin: 0 auto; }
    svg { width: 100%; height: auto; }
    .modal { position: fixed; top: 20px; right: 20px; background: white; border: 1px solid #ccc; padding: 15px; max-width: 300px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); display: none; z-index: 10; }
    .modal.active { display: block; }
    @media (max-width: 600px) {
      .modal { top: auto; bottom: 0; right: 0; left: 0; max-width: none; width: 100%; border-radius: 10px 10px 0 0; }
    }
    #suggestions { position: absolute; top: 65px; left: 10px; right: 10px; background: white; border: 1px solid #ddd; list-style: none; margin: 0; padding: 0; max-height: 240px; overflow-y: auto; display: none; z-index: 50; }
    #suggestions li { padding: 6px 8px; cursor: pointer; }
    #suggestions li:hover { background: #f0f0f0; }
  </style>
</head>
<body>
<div id="controls">
  <label>Sector:
    <select id="edificioSelect">
      <option value="Procesos">Procesos</option><option value="Termofluidos">Termofluidos</option><option value="Fundición">Fundición</option>
    </select>
  </label>
  <label>Piso:
    <select id="pisoSelect">
      <option value="P1">1</option><option value="P2">2</option><option value="P3">3</option><option value="P4">4</option>
    </select>
  </label>

  <div style="position:relative; flex:1; max-width:320px;">
    <input type="text" id="searchInput" placeholder="Buscar por nombre..." autocomplete="on" style="width:98%;">
    <ul id="suggestions"></ul>
  </div>

  <label><input type="checkbox" class="filterType" value="Sala" > Sala</label>
  <label><input type="checkbox" class="filterType" value="Laboratorio" > Laboratorio</label>
  <label><input type="checkbox" class="filterType" value="Oficina" > Oficina</label>
  <label><input type="checkbox" class="filterType" value="Bodega" > Bodega</label>

</div>

<div id="plano-container">
  <object id="svgPlano" type="image/svg+xml"></object>
</div>

<div id="infoModal" class="modal">
  <button id="closeModal" style="position:absolute;top:5px;right:5px;">&times;</button>
  <div id="modalContent"></div>
</div>

<script>

/* ---------- Diccionario de nombres de edificios ---------- */
const nombresEdificios = {
  "A": "Sector Procesos",
  "B": "Sector Termofluidos",
  "C": "Sector Fundición",
  "General": "Plano General"
};

/* ---------- Modal ---------- */
const modal = document.getElementById("infoModal");
document.getElementById("closeModal").addEventListener("click", ()=> modal.classList.remove("active"));
function showInfo(data){
  document.getElementById("modalContent").innerHTML = `
    <h3>${data.nombre}</h3>
    <p><strong>Tipo:</strong> ${data.tipo}</p>
    <p>${data.descripcion || ""}</p>
    ${data.media && data.media.foto ? `<img src="${data.media.foto}" alt="${data.nombre}" style="width:100%;">` : ""}
    ${data.media && data.media.video ? `<video controls style="width:100%;"><source src="${data.media.video}" type="video/mp4"></video>` : ""}
  `;
  modal.classList.add("active");
}

/* ---------- Marcadores ---------- */
let allMarkers = [];
function placeMarkers(svgRoot, ubicaciones){
  allMarkers = [];
  ubicaciones.forEach(ubicacion=>{
    const target = svgRoot.ownerDocument.getElementById(ubicacion.id);
    if(!target) return;

    if(!target.__attached){
      target.setAttribute("fill","transparent");
      target.setAttribute("opacity","1");
      target.setAttribute("stroke","white");
      target.style.cursor="pointer";
      target.dataset.nombre = (ubicacion.nombre||"").toLowerCase();
      target.dataset.tipo = (ubicacion.tipo||"").toLowerCase();
      target.addEventListener("mouseenter",()=> target.setAttribute("fill","black"));
      target.addEventListener("mouseleave",()=> target.setAttribute("fill","transparent"));
      target.addEventListener("click",()=> showInfo(ubicacion));
      target.__attached = true;
    }
    allMarkers.push(target);
  });
  aplicarFiltrosYBusqueda();
}

/* ---------- Filtros ---------- */
function aplicarFiltrosYBusqueda(){
  const search=document.getElementById("searchInput").value.toLowerCase();
  const checkedTypes=Array.from(document.querySelectorAll(".filterType:checked")).map(cb=>cb.value.toLowerCase());
  allMarkers.forEach(marker=>{
    const nombre=marker.dataset.nombre||"";
    const tipo=marker.dataset.tipo||"";
    const matchName=nombre.includes(search);
    const matchType=checkedTypes.includes(tipo);
    marker.style.visibility="visible";
    marker.style.pointerEvents="auto";
    if(search.length>0){
      marker.setAttribute("fill",(matchName&&matchType)?"black":"transparent");
    } else {
      marker.setAttribute("fill",matchType?"black":"transparent");
    }
  });
}
document.querySelectorAll(".filterType").forEach(cb=>cb.addEventListener("change",aplicarFiltrosYBusqueda));
document.getElementById("searchInput").addEventListener("input",aplicarFiltrosYBusqueda);

/* ---------- ZoomLayer seguro ---------- */
function crearZoomLayerSiHaceFalta(svgDoc){
  const svg = svgDoc.querySelector("svg");
  if(!svg) return null;

  let gWrapper = svg.querySelector("#zoomLayer");
  if(!gWrapper){
    // Creamos un grupo vacío arriba del todo
    gWrapper = svgDoc.createElementNS("http://www.w3.org/2000/svg", "g");
    gWrapper.setAttribute("id", "zoomLayer");

    // Insertamos el grupo como el último hijo del <svg>,
    // SIN mover nada de lo existente
    svg.appendChild(gWrapper);
  }
  return gWrapper;
}


/* ---------- Cargar plano ---------- */
function cargarPlano(){
  const edificio=document.getElementById("edificioSelect").value;
  const piso=document.getElementById("pisoSelect").value;
  const svgFile=`edificios/edificio${edificio}_piso${piso}.svg`;
  const jsonFile=`data/ubicaciones_edificio${edificio}_piso${piso}.json`;
  const obj=document.getElementById("svgPlano");
  obj.setAttribute("data",svgFile);
  obj.onload=function(){
    const svgDoc=obj.contentDocument;
    if(!svgDoc) return;
    const gWrapper=crearZoomLayerSiHaceFalta(svgDoc);
    fetch(jsonFile).then(r=>r.json()).then(data=> placeMarkers(gWrapper,data));
  };
}
document.getElementById("edificioSelect").addEventListener("change",cargarPlano);
document.getElementById("pisoSelect").addEventListener("change",cargarPlano);

/* ---------- Autocomplete global ---------- */
function debounce(fn,wait){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait);};}
const INDEX_FILE="data/ubicaciones_index.json"; let mapsIndex=[],nameIndex=[],currentMap=null;
async function buildIndex(){
  const res=await fetch(INDEX_FILE);
  mapsIndex=await res.json().then(j=>j.maps||j);
  await Promise.all(mapsIndex.map(async entry=>{
    try{const r=await fetch(entry.json);if(!r.ok)return;const items=await r.json();
      items.forEach(it=>nameIndex.push({nombreLower:(it.nombre||"").toLowerCase(),item:it,mapEntry:entry}));
    }catch(e){} }));
}
const suggestionsEl=document.getElementById("suggestions"),searchInput=document.getElementById("searchInput");

function showSuggestions(list){
  suggestionsEl.innerHTML="";
  if(!list.length){ suggestionsEl.style.display="none"; return; }

  list.forEach(s=>{
    const li = document.createElement("li");
    const edificioNombre = nombresEdificios[s.mapEntry.edificio] || s.mapEntry.edificio;
    li.textContent = `${s.item.nombre} - ${edificioNombre} - Piso ${s.mapEntry.piso}`;
    li.onclick = ()=> selectSuggestion(s);
    suggestionsEl.appendChild(li);
  });

  suggestionsEl.style.display="block";
}

function clearSuggestions(){suggestionsEl.style.display="none"; suggestionsEl.innerHTML="";}
searchInput.addEventListener("input",debounce(()=>{
  const q=searchInput.value.trim().toLowerCase(); if(!q){clearSuggestions();return;}
  const starts=nameIndex.filter(n=>n.nombreLower.startsWith(q)).slice(0,10);
  const contains=nameIndex.filter(n=>n.nombreLower.includes(q)&&!n.nombreLower.startsWith(q)).slice(0,10-starts.length);
  showSuggestions(starts.concat(contains));
  },150));
  searchInput.addEventListener("keydown",e=>{
    if(e.key==="Enter"){const q=searchInput.value.trim().toLowerCase();if(!q)return;
      const pick=nameIndex.find(n=>n.nombreLower===q)||nameIndex.find(n=>n.nombreLower.startsWith(q));
      if(pick) selectSuggestion(pick); clearSuggestions();}
    else if(e.key==="Escape") clearSuggestions();
});

/* ---------- Select suggestion ---------- */
async function selectSuggestion(entry){
  const mapEntry=entry.mapEntry;
  if(!currentMap||currentMap.svg!==mapEntry.svg){
    document.getElementById("edificioSelect").value=mapEntry.edificio||"A";
    document.getElementById("pisoSelect").value=mapEntry.piso||"1";
    const obj=document.getElementById("svgPlano");
    await new Promise(resolve=>{obj.setAttribute("data",mapEntry.svg);obj.onload=()=>resolve();});
    currentMap=mapEntry;
    const r=await fetch(mapEntry.json);const data=await r.json();
    const svgDoc=obj.contentDocument; const gWrapper=crearZoomLayerSiHaceFalta(svgDoc);
    placeMarkers(gWrapper,data);
  }
  focusOnLocation(entry.item); clearSuggestions();
}

/* ---------- Focus ---------- */
function focusOnLocation(ubicacion){
  const obj=document.getElementById("svgPlano"),svgDoc=obj.contentDocument;if(!svgDoc)return;
  const svg=svgDoc.querySelector("svg");const el=svgDoc.getElementById(ubicacion.id);if(!el)return;
  nameIndex.forEach(n=>{try{const e=svgDoc.getElementById(n.item.id);if(e)e.setAttribute("fill","transparent");}catch(e){}});
  el.setAttribute("fill","black"); el.setAttribute("opacity","0.9");
  const bbox=el.getBBox(),vbW=svg.viewBox.baseVal.width,vbH=svg.viewBox.baseVal.height;
  const scale=Math.max(1,Math.min(5,Math.min(vbW/(bbox.width*3),vbH/(bbox.height*3))));
  const g=svg.querySelector("#zoomLayer");if(!g)return;
  const tx=vbW/2-(bbox.x+bbox.width/2)*scale;const ty=vbH/2-(bbox.y+bbox.height/2)*scale;
  g.setAttribute("transform",`translate(${tx},${ty}) scale(${scale})`);
  showInfo(ubicacion);
}

/* ---------- Inicio ---------- */
window.addEventListener("load",async()=>{
  await buildIndex();
  const general=mapsIndex.find(m=>(m.edificio&&m.edificio.toLowerCase()==="general")||m.piso===0);
  const defaultMap=general||mapsIndex[0];
  if(defaultMap){
    document.getElementById("edificioSelect").value=defaultMap.edificio||"A";
    document.getElementById("pisoSelect").value=defaultMap.piso||"1";
    document.getElementById("svgPlano").setAttribute("data",defaultMap.svg);
    currentMap=defaultMap;
  }
});
</script>
</body>
</html>
